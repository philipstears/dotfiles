#!/usr/bin/env bash
set -eu -o pipefail

declare PROG_NAME=$0
declare DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")"; pwd)
source $DIR/../../include/utils

main() {
  sudo apt-get update
  
  sudo apt-get install apt-transport-https ca-certificates
  
  sudo apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D
  
  local -r code_name=$(lsb_release -c | awk '{print $2}')
  local -r repository=$(printf 'deb https://apt.dockerproject.org/repo ubuntu-%s main' $code_name)
  
  echo "$repository" | sudo tee /etc/apt/sources.list.d/docker.list
  
  sudo apt-get update
  
  if ! command -v docker 2&> /dev/null; then
    if [[ "$code_name" == "trusty" ]]; then
      sudo apt-get -y install linux-image-generic-lts-trusty
    fi
    sudo apt-get -y install docker-engine
  fi

  if [[ -z "$(getent group docker)" ]]; then
    sudo groupadd docker
  fi

  sudo usermod -aG docker $USER

  sudo systemctl enable docker

  sudo systemctl start docker
}

main
