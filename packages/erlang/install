#!/usr/bin/env bash
set -eu -o pipefail

declare PROG_NAME=$0
declare DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")"; pwd)
source $DIR/../../include/utils

main() {
  local build_name="std-18-3"

  if is_command_available kerl; then
    echo "KERL already seems to be available."
  else
    echo "Downloading and installing kerl..."
    install_kerl
  fi

  if (kerl list builds | grep "$build_name"); then
    echo "Erlang 18.3 already built."
  else
    echo "Building Erlang 18.3..."
    install_packages ncurses-devel
    kerl build 18.3 "$build_name"
  fi

  kerl install "$build_name" "$HOME/.local/opt/erlang/$build_name"
}

install_kerl() {
  local kerl_dir="$(per_user_opt_dir)/kerl"
  local kerl="$kerl_dir/kerl"

  mkdir -p "$kerl_dir"
  curl -Llsso "$kerl" https://raw.githubusercontent.com/kerl/kerl/master/kerl
  chmod +x "$kerl"
  link_usr_bin "$kerl" kerl
}

main
